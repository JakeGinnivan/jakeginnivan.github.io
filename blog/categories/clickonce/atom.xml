<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: ClickOnce | Jake Ginnivan's blog]]></title>
  <link href="http://jake.ginnivan.net/blog/categories/clickonce/atom.xml" rel="self"/>
  <link href="http://jake.ginnivan.net/"/>
  <updated>2014-06-11T03:15:02+08:00</updated>
  <id>http://jake.ginnivan.net/</id>
  <author>
    <name><![CDATA[Jake Ginnivan]]></name>
    <email><![CDATA[jake@ginnivan.net]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[ClickOnce Signing Error]]></title>
    <link href="http://jake.ginnivan.net/clickonce-signing-error/"/>
    <updated>2013-09-13T00:00:00+08:00</updated>
    <id>http://jake.ginnivan.net/clickonce-signing-error</id>
    <content type="html"><![CDATA[<p>On my current project we use ClickOnce, and I am setting up the build server to sign using a proper cert rather than a self generated one.</p>

<p>The command:</p>

<pre><code>mage.exe -New Application -ToFile &lt;path&gt;\App.exe.manifest -name "&lt;Name&gt;" -Version 0.1.1.1 -FromDirectory &lt;path&gt;\0.1.1.1\ -IconFile App.ico -CertHash "‏ca5da5a1f7c57411111111a79cbf50c4432ed949"
</code></pre>

<p>And was getting <code>This certificate cannot be used for signing - "ca5da5a1f7c57411111111a79cbf50c4432ed949"</code></p>

<p>I was searching for what extended attributes are required, checking if I got the right thumbprint and wasted a bunch of time.</p>

<p>The fix was simple, <strong>remove the quotes</strong> around the thumbprint</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ClickOnce from Azure Blob Storage]]></title>
    <link href="http://jake.ginnivan.net/clickonce-from-azure-blob-storage/"/>
    <updated>2013-08-08T00:00:00+08:00</updated>
    <id>http://jake.ginnivan.net/clickonce-from-azure-blob-storage</id>
    <content type="html"><![CDATA[<p>Even with all it&rsquo;s problems ClickOnce is actually a decent option if you want a simple installer and an application which Self Updates.</p>

<h2>Creating the ClickOnce installer</h2>

<p>I don&rsquo;t like using the publish feature in VS for my ClickOnce installers, it causes more problems than it solves. I tend to use Mage directly, but this is sometimes not that easy to figure out how to do it. Lets start by creating our installer.</p>

<p>I am using MSBuild as my build platform, but these instructions can be adapted to anything really.</p>

<!-- more -->


<h3>Properties</h3>

<pre><code>&lt;PropertyGroup&gt;
  &lt;Version Condition="$(VERSION)==''"&gt;0.0.0.1&lt;/Version&gt;
  &lt;ClickOnceFolder&gt;$(MSBuildProjectDirectory)artifacts\ClickOnce\&lt;/ClickOnceFolder&gt;
  &lt;ClickOnceFiles&gt;$(ClickOnceFolder)$(Version)\&lt;/ClickOnceFiles&gt;
  &lt;Mage&gt;$(MSBuildProjectDirectory)tools\mage.exe&lt;/Mage&gt;
  &lt;ProviderUrlArg Condition="$(ProviderUrl)!=''"&gt;-ProviderURL $(ProviderUrl)&lt;/ProviderUrlArg&gt;
  &lt;ClickOnceName Condition="$(ClickOnceName)==''"&gt;MarkPad&lt;/ClickOnceName&gt;
&lt;/PropertyGroup&gt;
&lt;ItemGroup&gt;
  &lt;SourceFiles Include="$(MSBuildProjectDirectory)src\My.App\bin\$(Configuration)\**\*.*" /&gt;
&lt;/ItemGroup&gt;
</code></pre>

<p>The provider URL is so we can embed the installation URL into the installer, this will make ClickOnce work in Chrome and other browsers. Chrome downloads the .application file, then the user runs it from the <code>Downloads</code> folder, at that point ClickOnce has no idea where it was downloaded from, so the install fails.
With the provider url embedded, it will work as expected.</p>

<p>Most of the properties above should be easy to understand what they are for.</p>

<h3>Creating the installer</h3>

<h4>1. Copy the application binaries into a Version folder</h4>

<pre><code>&lt;Copy SourceFiles="@(SourceFiles)" DestinationFolder="$(ClickOnceFiles)%(SourceFiles.RecursiveDir)"/&gt;
</code></pre>

<h4>2. Create the .manifest file for the application</h4>

<pre><code>&lt;Exec Command="$(Mage) -New Application -ToFile $(ClickOnceFiles)MyApp.exe.manifest -Processor x86 -name &amp;quot;$(ClickOnceName)&amp;quot; -Version $(Version) -FromDirectory $(ClickOnceFiles) -IconFile icon.ico" /&gt;
</code></pre>

<p>This creates the .manifest file, which is information about that particular version of the software. It lives inside the folder with all the binaries.</p>

<h4>3. Perform updates to manifest (optional)</h4>

<pre><code>&lt;Exec Command="powershell.exe -ExecutionPolicy RemoteSigned -NoProfile $(Root)tools\UpdateManifest.ps1 -ManifestFile $(ClickOnceFiles)MyApp.exe.manifest" /&gt;
</code></pre>

<p>If you have issues with certain assemblies failing the checksum (normally because of native dlls), I have used this code to fix the issue:</p>

<pre><code>Param($ManifestFile) 
write-host "Fixing up Manifest File"
write-host $ManifestFile

[xml]$xml = get-content $ManifestFile

$elementsToRewrite = $xml.assembly.dependency | where {$_.dependentAssembly.codebase -ne $null -and ($_.dependentAssembly.codebase.Contains("CefSharp") -or $_.dependentAssembly.codebase.Contains("NHunspell")) }
foreach ($elementToRewrite in $elementsToRewrite)
{
    $fileNode = $xml.CreateElement("file", "urn:schemas-microsoft-com:asm.v2")
    $fileNode.SetAttribute("name", $elementToRewrite.dependentAssembly.codebase)    
    $fileNode.SetAttribute("size", $elementToRewrite.dependentAssembly.size)
    $fileNode.AppendChild($elementToRewrite.dependentAssembly.hash) 
    $xml.assembly.AppendChild($fileNode)
    [Void]$xml.assembly.RemoveChild($elementToRewrite)
}

$xml.Save($ManifestFile)

write-host "Fixed Manfiest File"
</code></pre>

<p>Skip this step by default, introduce if you need it.</p>

<h4>4. Sign the .manifest file (optional)</h4>

<p>If you want to sign your installer, this is where you do that.</p>

<pre><code>&lt;Exec Command="$(Mage) -sign MyApp.manifest -CertFile $(Certificate) -Password $(CertPassword)" /&gt;
</code></pre>

<h4>5. Create the .application file</h4>

<pre><code>&lt;Exec Command="$(Mage) -New Deployment -ToFile $(ClickOnceFolder)MyApp.application -name &amp;quot;$(ClickOnceName)&amp;quot; -Processor x86 -Install true -Version $(Version) -Publisher &amp;quot;Your Company&amp;quot; -AppManifest $(ClickOnceFiles)MyApp.exe.manifest $(ProviderUrlArg)" /&gt;
</code></pre>

<p>This generates your deployment</p>

<h4>7. Update your deployment settings (optional)</h4>

<pre><code>&lt;Exec Command="powershell.exe -ExecutionPolicy RemoteSigned -NoProfile $(Root)tools\UpdateApplicationManifest.ps1 -ManifestFile $(ClickOnceFolder)MyApp.application" /&gt;
</code></pre>

<p>The powershell script looks like this</p>

<pre><code>Param($ManifestFile) 
write-host "Fixing up Manifest File"
write-host $ManifestFile

[xml]$xml = get-content $ManifestFile

$xml.assembly.deployment.SetAttribute("trustURLParameters", "true")
$xml.assembly.deployment.SetAttribute("mapFileExtensions", "true")

# Uncomment to tell your app to update before startup
#$xml.assembly.deployment.subscription.update.RemoveAll()
#$updateNode = $xml.CreateElement("beforeApplicationStartup", "urn:schemas-microsoft-com:asm.v2")
#$xml.assembly.deployment.subscription.Item("update").AppendChild($updateNode)

$xml.Save($ManifestFile)

write-host "Fixed Manfiest File"
</code></pre>

<p>This is where you can change when you want your app to check for updates, and modify deployment settings. More information about this file available at <a href="http://msdn.microsoft.com/en-us/library/k26e96zf.aspx">http://msdn.microsoft.com/en-us/library/k26e96zf.aspx</a></p>

<h4>7. Sign your deployment (optional)</h4>

<pre><code>&lt;Exec Command="$(Mage) -update MyApp.application -appmanifest MyApp.manifest -CertFile $(Certificate) -Password $(CertPassword)" /&gt;
</code></pre>

<p>This signs your deployment.</p>

<h4>8. Rename binaries to have the .deploy extension</h4>

<pre><code>&lt;ItemGroup&gt;
  &lt;DeploymentFiles Include="$(ClickOnceFiles)**\*.*" Exclude="$(ClickOnceFiles)MarkPad.exe.manifest" /&gt;
&lt;/ItemGroup&gt;

&lt;Move SourceFiles="@(DeploymentFiles)" DestinationFiles="@(DeploymentFiles-&gt;'%(RootDir)%(Directory)%(FileName)%(Extension).deploy')" /&gt;
</code></pre>

<p>This is so webservers will serve all the files, some extensions will not be served on some web servers, this gets around that issue.</p>

<p>To see it all working together, check out MarkPad&rsquo;s build script at <a href="https://github.com/Code52/DownmarkerWPF/blob/master/Markpad.msbuild#L31">https://github.com/Code52/DownmarkerWPF/blob/master/Markpad.msbuild#L31</a></p>

<h2>Deploying to Azure</h2>

<h3>Setup a storage account</h3>

<p><img src="/assets/posts/2013-08-08-clickonce-from-azure-blob-storage/ClickOnceInAzure.png" alt="Create Storage Account" /></p>

<p><img src="/assets/posts/2013-08-08-clickonce-from-azure-blob-storage/ClickOnceInAzure1.png" alt="Create Storage Account 2" /></p>

<p>Once created, go to the <code>containers</code> tab, then add a new container.
<img src="/assets/posts/2013-08-08-clickonce-from-azure-blob-storage/ClickOnceInAzure2.png" alt="Create Container" /></p>

<p>Make sure you choose <code>Public Container</code> as the access level, otherwise things will not work!</p>

<h3>Uploading deployment to Azure Storage</h3>

<p>For this I use a utility from the Azure team called AzCopy. See the blog post at <a href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/04/01/azcopy-using-cross-account-copy-blob.aspx">http://blogs.msdn.com/b/windowsazurestorage/archive/2013/04/01/azcopy-using-cross-account-copy-blob.aspx</a> and download it from <a href="http://go.microsoft.com/fwlink/?LinkId=287086">http://go.microsoft.com/fwlink/?LinkId=287086</a></p>

<p>Upload steps</p>

<pre><code>&lt;!--$(BlobTargetUrl) = https://myaccount.blob.core.windows.net/mycontainer/ --&gt;

&lt;!--Upload everything except the application manifest as it should be done last (once everything else is uploaded)--&gt;
&lt;Move SourceFiles="$(ClickOnceFolder)MyApp.application" DestinationFolder="$(ClickOnceFolder)ClickOnceApplicationFile\" /&gt;
&lt;Exec Command="$(Root)tools\AzCopy.exe $(ClickOnceFolder) $(BlobTargetUrl) /destkey:$(BlobTargetKey) /S /V /Y" /&gt;
&lt;Exec Command="$(Root)tools\AzCopy.exe $(ClickOnceFolder)ClickOnceApplicationFile\ $(BlobTargetUrl) /destkey:$(BlobTargetKey) /S /V /Y" /&gt;
</code></pre>

<p>What we are doing here is moving all the files, except the .application file, and uploading them first. Then finally uploading the .application file once all the other files are uploaded. This is so you do not have a corrupted installer while you are uploading the new version.</p>

<h3>Install from Azure</h3>

<p>Now you just point at the .application file, for example MarkPad&rsquo;s nightly is available from <a href="http://ginnivan.blob.core.windows.net/markpadnightly/MarkPad.application">http://ginnivan.blob.core.windows.net/markpadnightly/MarkPad.application</a></p>

<p>Hope this helps you out, I have found this is a really cheap and easy way to get ClickOnce installers out there!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ClickOnce Deployment in TeamCity]]></title>
    <link href="http://jake.ginnivan.net/clickonce-deployment-in-teamcity/"/>
    <updated>2009-08-29T00:00:00+08:00</updated>
    <id>http://jake.ginnivan.net/clickonce-deployment-in-teamcity</id>
    <content type="html"><![CDATA[<p>I have been trying to get a ClickOnce VSTO add-in publishing automatically during a build and do not want visual studio on my build server.</p>

<p>This blog post was very useful for getting the initial build working <a href="http://abdullin.com/journal/2009/2/17/building-vsto-solutions-without-visual-studio.html">http://abdullin.com/journal/2009/2/17/building-vsto-solutions-without-visual-studio.html</a> it also mentions how to fix the error MSB3147: Could not find required file &lsquo;setup.bin&rsquo; in &lsquo;ProjectFolder\Engine&rsquo; error I was getting.</p>

<p>According to the post we just have to copy the Generic Bootstrapper across to our build machine and create a registry key to let .net know where to find it.</p>

<p>What all the resources (I have seen the same fix posted in a lot of places) fail to mention is the registry key that you need to modify if you are running a x64 system is HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Microsoft\GenericBootstrapper\3.5.</p>

<p>This Wow6432Node key has got me a few times before…</p>
]]></content>
  </entry>
  
</feed>
