
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Cleaning up Office COM Interop Code with Extension Methods - Jake Ginnivan's blog</title>
  <meta name="author" content="Jake Ginnivan">

  
  <meta name="description" content="Office Automation and COM interop code can be really ugly, this post show you how the extension methods in VSTO Contrib can help">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jake.ginnivan.net/vsto-contrib/com-cleanup-extension-methods/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/feed" rel="alternate" title="Jake Ginnivan's blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-42948513-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Jake Ginnivan's blog</a></h1>
  
  <ul class="social-links">
  
    <li><a class="feed" href="/feed" title="RSS"></a></li>
  
  
    <li><a class="twitter" href="http://twitter.com/JakeGinnivan" title="Twitter" target="_black"></a></li>
  
  
    <li><a class="github" href="https://github.com/JakeGinnivan" title="GitHub" target="_black"></a></li>
  
</ul>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/feed" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jake.ginnivan.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about-me">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Cleaning Up Office COM Interop Code With Extension Methods</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-04-05T00:00:00+01:00" pubdate data-updated="true">Apr 5<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Office Automation and COM interop code can be really ugly, this post show you how the extension methods in VSTO Contrib can help</p>

<!-- more -->


<h1>Ugly Office Automation Code</h1>

<p>You have been tasked with the simple job of writing a console application which goes through every contact in an Outlook addressbook and replacing Smith, John with John Smith. Because you want Outlook 2003 to close properly when you call quit, you make sure you manage your references properly. The code you come up with looks something like:</p>

<pre><code>_Application app;
_NameSpace session;
_MAPIFolder folder;
Items contactItems;
try
{
    app = new Application();
    session = app.Session;
    folder = session.GetDefaultFolder(OlDefaultFolders.olFolderContacts);
    contactItems = folder.Items;
    foreach (_ContactItem contactItem in folder.Items)
    {
        try
        {
            if (!string.IsNullOrEmpty(contactItem.FullName))
            {
                contactItem.FileAs = contactItem.FullName;
                contactItem.Save();
            }
        }
        finally
        {
            if (Marshal.IsComObject(contactItem))
                Marshal.ReleaseComObject(contactItem);
        }
    }
}
finally
{
    if (contactItems != null &amp;&amp; Marshal.IsComObject(contactItems))
        Marshal.ReleaseComObject(contactItems);
    if (folder != null &amp;&amp; Marshal.IsComObject(folder))
        Marshal.ReleaseComObject(folder);
    if (session != null &amp;&amp; Marshal.IsComObject(session))
        Marshal.ReleaseComObject(session);

    if (app != null)
    {
        app.Quit();
        if (Marshal.IsComObject(app))
            Marshal.ReleaseComObject(app);
    }
}
</code></pre>

<p>The above code and way too much code to easily scan and see what is going on.</p>

<h2>Better code</h2>

<p>So what does it look like using the simple helpers:</p>

<pre><code>using (var app = new Application().WithComCleanup())
{
    using (var session = app.Resource.Session.WithComCleanup())
    {
        var folder = session.Resource.GetDefaultFolder(OlDefaultFolders.olFolderContacts);
        using (var contactsFolder = folder.Resource.WithComCleanup())
        {
            foreach (var contactItem in contactsFolder.Resource.Items.ComLinq&lt;_ContactItem&gt;())
            {
                if (!string.IsNullOrEmpty(contactItem.FullName))
                {
                    contactItem.FileAs = contactItem.FullName;
                    //contactItem.Save();
                }
            }
        }
    }
    app.Quit();
}
</code></pre>

<h1>Introducing Dynamic Proxies</h1>

<p>The reason we can&rsquo;t do this, is the COM land doesn&rsquo;t understand IDisposable. So VSTO Contrib has a generated set of interfaces that look like this:</p>

<pre><code>public interface IApplication : Microsoft.Office.Interop.Outlook.Application, IDisposable { }
</code></pre>

<p>The .WithComCleanup actually is also generated, so it looks like this:</p>

<pre><code>public static IApplication WithComCleanup(this Outlook.Application resource)
{  return resource.WithComCleanup&lt;Outlook.Application, IApplication&gt;(); }
</code></pre>

<p>The generic version will generate a proxy on the fly, and will call Marshal.ReleaseComObject on the proxied resource when Dispose is called. The end result is we now no longer have .Resource scattered all through our code, which again improves readability.</p>

<pre><code>using (var app = new Application().WithComCleanup())
{
    using (var session = app.Session.WithComCleanup())
    {
        var folder = session.GetDefaultFolder(OlDefaultFolders.olFolderContacts);
        using (var contactsFolder = folder.WithComCleanup())
        {
            foreach (var contactItem in contactsFolder.Items.ComLinq&lt;_ContactItem&gt;())
            {
                if (!string.IsNullOrEmpty(contactItem.FullName))
                {
                    contactItem.FileAs = contactItem.FullName;
                    //contactItem.Save();
                }
            }
        }
    }
    app.Quit();
}
</code></pre>

<p>I think you would agree that this code is far better than the first example. And the difference becomes more dramatic as the complexity grows.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jake Ginnivan</span></span>

      








  


<time datetime="2011-04-05T00:00:00+01:00" pubdate data-updated="true">Apr 5<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/open-source/'>Open Source</a>, <a class='category' href='/blog/categories/vsto/'>VSTO</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://jake.ginnivan.net/vsto-contrib/com-cleanup-extension-methods/" data-via="JakeGinnivan" data-counturl="http://jake.ginnivan.net/vsto-contrib/com-cleanup-extension-methods/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/retry-for-class/" title="Previous Post: Retry.For">&laquo; Retry.For</a>
      
      
        <a class="basic-alignment right" href="/vsto-contrib/introduction/" title="Next Post: Introduction to VSTO Contrib">Introduction to VSTO Contrib &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/01/14/nunit-263-async-and-dotnet40-broken/">nUnit 2.6.3, async and .net 4.0 broken</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/10/on-async-and-sync-contexts/">On Async and Sync Contexts</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/05/blog-migration/">Blog Migration</a>
      </li>
    
      <li class="post">
        <a href="/gitreleasenotes/">GitReleaseNotes Initial Release!</a>
      </li>
    
      <li class="post">
        <a href="/git-flow-versioning/">Git Flow Versioning</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
  <div id="category-buttons-list"><div class="category-button"><a href="/blog/categories/dot-net/">.NET</a><span class="category-count">6</span></div><div class="category-button"><a href="/blog/categories/async/">Async</a><span class="category-count">3</span></div><div class="category-button"><a href="/blog/categories/async/">async</a><span class="category-count">1</span></div><div class="category-button"><a href="/blog/categories/automapper/">AutoMapper</a><span class="category-count">1</span></div><div class="category-button"><a href="/blog/categories/azure/">Azure</a><span class="category-count">3</span></div><div class="category-button"><a href="/blog/categories/clickonce/">ClickOnce</a><span class="category-count">3</span></div><div class="category-button"><a href="/blog/categories/continuous-delivery/">Continuous Delivery</a><span class="category-count">2</span></div><div class="category-button"><a href="/blog/categories/git/">Git</a><span class="category-count">3</span></div><div class="category-button"><a href="/blog/categories/gitflow/">GitFlow</a><span class="category-count">1</span></div><div class="category-button"><a href="/blog/categories/github/">GitHub</a><span class="category-count">3</span></div><div class="category-button"><a href="/blog/categories/jira/">Jira</a><span class="category-count">1</span></div><div class="category-button"><a href="/blog/categories/log4net/">log4net</a><span class="category-count">1</span></div><div class="category-button"><a href="/blog/categories/msbuild/">MSBuild</a><span class="category-count">1</span></div><div class="category-button"><a href="/blog/categories/nuget/">NuGet</a><span class="category-count">3</span></div><div class="category-button"><a href="/blog/categories/open-source/">Open Source</a><span class="category-count">20</span></div><div class="category-button"><a href="/blog/categories/presenting/">Presenting</a><span class="category-count">8</span></div><div class="category-button"><a href="/blog/categories/resharper/">ReSharper</a><span class="category-count">2</span></div><div class="category-button"><a href="/blog/categories/semantic-versioning/">Semantic Versioning</a><span class="category-count">1</span></div><div class="category-button"><a href="/blog/categories/teamcity/">TeamCity</a><span class="category-count">5</span></div><div class="category-button"><a href="/blog/categories/testing/">Testing</a><span class="category-count">5</span></div><div class="category-button"><a href="/blog/categories/teststack/">TestStack</a><span class="category-count">2</span></div><div class="category-button"><a href="/blog/categories/tfs/">TFS</a><span class="category-count">2</span></div><div class="category-button"><a href="/blog/categories/ui-automation/">UI Automation</a><span class="category-count">6</span></div><div class="category-button"><a href="/blog/categories/vsto/">VSTO</a><span class="category-count">17</span></div><div class="category-button"><a href="/blog/categories/webapi/">WebApi</a><span class="category-count">1</span></div><div class="category-button"><a href="/blog/categories/white/">White</a><span class="category-count">2</span></div><div class="category-button"><a href="/blog/categories/windows-phone/">Windows Phone</a><span class="category-count">9</span></div><div class="category-button"><a href="/blog/categories/wpf/">Wpf</a><span class="category-count">8</span></div></ul>
</section>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/JakeGinnivan">@JakeGinnivan</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'JakeGinnivan',
            count: 6,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Jake Ginnivan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  - <span class="credit">Theme by <a href="http://www.gehaxelt.in">Gehaxelt</a></span>
  <span class="credit">and <a href="http://www.it-solutions-neef.de">IT Solutions Neef</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jakeginnivansblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://jake.ginnivan.net/vsto-contrib/com-cleanup-extension-methods/';
        var disqus_url = 'http://jake.ginnivan.net/vsto-contrib/com-cleanup-extension-methods/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
